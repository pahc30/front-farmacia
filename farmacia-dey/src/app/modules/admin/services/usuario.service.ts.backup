import { Injectable } from '@angular/core';
import { Observable, map, switchMap } from 'rxjs';
import { HttpClient } from '@angular/common/http';
import { environment } from '../../../../environments/environment';

@Injectable({
  providedIn: 'root',
})
export class UsuarioService {
  private basePath = environment.baseUrlBackend + '/usuario/api';
  private authBasePath = environment.baseUrlBackend + '/auth/api';

  constructor(private http: HttpClient) { }

  save = (dato: any): Observable<any> => {
    const path = this.basePath + `/usuarios/save`;
    return this.http.post<any>(path, dato).pipe(map((res) => res));
  }

  // Nuevo método que crea usuario con credenciales de login
  saveWithAuth = (dato: any): Observable<any> => {
    // Primero registrar en auth_schema (para login)
    const authPath = this.authBasePath + `/auth/register`;
    const authData = {
      username: dato.username,
      password: dato.password,
      nombres: dato.nombres,
      apellidos: dato.apellidos,
      identificacion: dato.identificacion,
      email: dato.email,
      telefono: dato.telefono,
      direccion: dato.direccion,
      rol: dato.rol
    };
    
    return this.http.post<any>(authPath, authData).pipe(
      switchMap((authRes) => {
        // Si auth fue exitoso, crear en usuario_schema
        if (authRes.estado === 1) {
          const usuarioPath = this.basePath + `/usuarios/save`;
          return this.http.post<any>(usuarioPath, dato).pipe(
            map((usuarioRes) => {
              // Retornar respuesta combinada
              return {
                estado: 1,
                mensaje: 'Usuario creado exitosamente con acceso de login',
                dato: {
                  auth: authRes.dato,
                  usuario: usuarioRes.dato
                }
              };
            })
          );
        } else {
          // Si auth falló, retornar error
          return new Observable(observer => {
            observer.next({
              estado: 0,
              mensaje: 'Error al crear credenciales de acceso: ' + authRes.mensaje,
              dato: null
            });
            observer.complete();
          });
        }
      })
    );
  }

  update = (dato: any, id: any): Observable<any> => {
    const path = this.basePath + `/usuarios/update/${id}`;
    return this.http.post<any>(path, dato).pipe(map((res) => res));
  }

  delete = (id: any): Observable<any> => {
    const path = this.basePath + `/usuarios/delete/${id}`;
    return this.http.post<any>(path, null).pipe(map((res) => res));
  }

  find = (id: any): Observable<any> => {
    const path = this.basePath + `/usuarios/find/${id}`;
    return this.http.post<any>(path, null).pipe(map((res) => res));
  }

  list = (): Observable<any> => {
    const path = this.basePath + `/usuarios/list`;
    return this.http.post<any>(path, null).pipe(map((res) => res));
  }

}
