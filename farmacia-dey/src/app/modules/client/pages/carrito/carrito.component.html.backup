<div class="container">
  <div>
    <h5 class="font-semibold">CARRITO DE COMPRA</h5>
    <hr />
  </div>

  <!-- Tabla -->
  <div class="flex overflow-x-auto mt-5" *ngIf="!mostrarProcesoPago">
    <div class="mat-elevation-z1 w-full">
      <table mat-table [dataSource]="dataSource" matSort>
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>#</th>
          <td mat-cell *matCellDef="let row; let i = index">{{ i + 1 }}</td>
        </ng-container>

        <ng-container matColumnDef="codigo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Código</th>
          <td mat-cell *matCellDef="let row">{{ row.producto.codigo }}</td>
        </ng-container>

        <ng-container matColumnDef="nombre">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
          <td mat-cell *matCellDef="let row">{{ row.producto.nombre }}</td>
        </ng-container>

        <ng-container matColumnDef="precio">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Precio</th>
          <td mat-cell *matCellDef="let row">S/. {{ row.producto.precio }}</td>
        </ng-container>

        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Cantidad</th>
          <td mat-cell *matCellDef="let row">{{ row.cantidad }}</td>
        </ng-container>

        <ng-container matColumnDef="categoria">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoría</th>
          <td mat-cell *matCellDef="let row">{{ row.producto.categoria.nombre }}</td>
        </ng-container>

        <ng-container matColumnDef="imagen">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Imagen</th>
          <td mat-cell *matCellDef="let row">
            <div class="p-2">
              <img class="max-w-30 max-h-30 border" src="{{row.producto.url}}" alt="">
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let row">
            <div class="flex justify-center gap-2">
              <button mat-mini-fab color="warn" (click)="onClickEliminar(row)" matTooltip="Eliminar">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell text-center font-medium" [attr.colspan]="displayedColumns.length">
            Sin registros
          </td>
        </tr>
      </table>

      <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons aria-label="Select page of users">
      </mat-paginator>
    </div>
  </div>

  <!-- Sección de Pago -->
  <div class="mt-8" *ngIf="!mostrarProcesoPago">
    <div class="bg-gray-50 p-6 rounded-lg">
      <h6 class="font-semibold mb-4">RESUMEN DE COMPRA</h6>
      
      <div class="flex justify-between mb-4">
        <span class="text-lg font-medium">Total: S/. {{ total }}</span>
      </div>

      <form [formGroup]="form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Método de Pago</label>
          <mat-select formControlName="metodo" placeholder="Seleccione método de pago" class="w-full">
            <mat-option *ngFor="let metodo of metodos" [value]="metodo.id">
              {{ metodo.nombre }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="frmValidationUtils.hasErrors('metodo')">
            {{ frmValidationUtils.getErrorMessages('metodo', 'Método de pago') }}
          </mat-error>
        </div>

        <div class="flex gap-4 pt-4">
          <button mat-raised-button color="primary" (click)="onClickPagar()" 
                  [disabled]="productos.length === 0" class="flex-1">
            <mat-icon>shopping_cart</mat-icon>
            REALIZAR COMPRA
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Proceso de Pago -->
  <div class="mt-8" *ngIf="mostrarProcesoPago">
    <div class="bg-blue-50 p-6 rounded-lg">
      <h6 class="font-semibold mb-4">PROCESO DE PAGO</h6>
      
      <div class="space-y-4">
        <div class="flex justify-between">
          <span>Compra #:</span>
          <span class="font-medium">{{ compraRealizada?.codigo }}</span>
        </div>
        
        <div class="flex justify-between">
          <span>Monto:</span>
          <span class="font-medium">S/. {{ total }}</span>
        </div>
        
        <div class="flex justify-between">
          <span>Método:</span>
          <span class="font-medium">{{ transaccionCreada?.metodoPago }}</span>
        </div>

        <div class="bg-white p-4 rounded border-l-4 border-blue-500">
          <p class="text-sm text-gray-600 mb-3">
            Intent de pago creado exitosamente. 
            <br>ID de Transacción: <strong>{{ transaccionCreada?.transaccionId }}</strong>
          </p>
          
          <!-- Botones de simulación según el método -->
          <div class="flex gap-3">
            <button mat-raised-button color="accent" (click)="simularPagoYape()" 
                    *ngIf="transaccionCreada?.metodoPago?.toLowerCase().includes('yape') || 
                           transaccionCreada?.metodoPago?.toLowerCase().includes('plin')">
              <mat-icon>phone_android</mat-icon>
              SIMULAR PAGO YAPE/PLIN
            </button>
            
            <button mat-raised-button color="accent" (click)="simularPagoVisa()" 
                    *ngIf="transaccionCreada?.metodoPago?.toLowerCase().includes('visa')">
              <mat-icon>credit_card</mat-icon>
              SIMULAR PAGO VISA
            </button>
            
            <button mat-raised-button color="primary" (click)="confirmarPago()">
              <mat-icon>check_circle</mat-icon>
              CONFIRMAR PAGO MANUAL
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sección de descarga de boleta -->
  <div class="mt-6" *ngIf="compraRealizada && !mostrarProcesoPago">
    <div class="bg-green-50 p-4 rounded-lg">
      <h6 class="font-semibold mb-3">¡COMPRA REALIZADA EXITOSAMENTE!</h6>
      <p class="text-sm text-gray-600 mb-3">
        Su compra #{{ compraRealizada.codigo }} ha sido procesada correctamente.
      </p>
      
      <div class="flex gap-3">
        <button mat-raised-button color="accent" (click)="descargarBoleta()">
          <mat-icon>download</mat-icon>
          DESCARGAR BOLETA PDF
        </button>
        
        <button mat-stroked-button color="primary" routerLink="/client/compras">
          <mat-icon>history</mat-icon>
          VER MIS COMPRAS
        </button>
      </div>
    </div>
  </div>
</div>
