<div class="container">
  <div>
    <h5 class="font-semibold">MIS COMPRAS</h5>
    <hr />
  </div>

  <!-- Tabla -->
  <div class="overflow-auto pt-5">
    <div class="flex flex-wrap">

      <div class="w-full border-b mb-4" *ngFor="let item of compras">

        <mat-card class="h-full !bg-gray-100 !shadow-md">
          <mat-card-header class="w-full text-c_secondary">
            <div class="w-full flex justify-between items-center">
              <div class="flex items-center gap-4">
                <div class="font-semibold">Código: {{ item.codigo }}</div>
                <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">
                  {{ calcularTotalProductos(item.detalleCompra) }} productos
                </span>
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-600">{{ item.fecha | date:'yyyy/MM/dd HH:mm' }}</div>
                <div class="font-semibold text-lg">S/. {{ item.total }}</div>
              </div>
            </div>
          </mat-card-header>
          
          <mat-card-content class="h-full">
            <div class="flex flex-col">
              <div class="flex justify-between flex-wrap pt-3 pb-3 border-b">
                <div class="text-sm">
                  <label class="font-medium">Método de pago: </label> 
                  <span class="text-gray-700">{{ item.metodoPago }}</span>
                </div>
                <div class="text-sm">
                  <label class="font-medium">IGV: </label> 
                  <span class="text-gray-700">{{ item.igv * 100 }}%</span>
                </div>
                <div class="text-sm">
                  <label class="font-medium">Subtotal: </label> 
                  <span class="text-gray-700">S/. {{ item.subtotal }}</span>
                </div>
              </div>

              <!-- Botones de acción -->
              <div class="flex gap-3 py-4">
                <button mat-raised-button color="primary" (click)="descargarBoleta(item.id)">
                  <mat-icon>download</mat-icon>
                  DESCARGAR BOLETA
                </button>
                
                <button mat-stroked-button color="accent" (click)="obtenerTransacciones(item.id)">
                  <mat-icon>payment</mat-icon>
                  VER TRANSACCIONES
                </button>
              </div>

              <div>
                <mat-accordion>
                  <mat-expansion-panel class="!rounded-md !shadow-sm">
                    <mat-expansion-panel-header class="!bg-gray-50">
                      <mat-panel-title>
                        <mat-icon class="mr-2">list_alt</mat-icon>
                        Detalle de compra
                      </mat-panel-title>
                    </mat-expansion-panel-header>

                    <div class="overflow-x-auto">
                      <table class="w-full min-w-full">
                        <thead class="bg-gray-50">
                          <tr>
                            <th class="text-start p-3 font-medium">Imagen</th>
                            <th class="text-start p-3 font-medium">Cantidad</th>
                            <th class="text-start p-3 font-medium">Código</th>
                            <th class="text-start p-3 font-medium">Producto</th>
                            <th class="text-start p-3 font-medium">Categoría</th>
                            <th class="text-start p-3 font-medium">Precio Unit.</th>
                            <th class="text-start p-3 font-medium">Subtotal</th>
                          </tr>
                        </thead>
                        <tbody class="text-c_secondary">
                          <tr *ngFor="let d of item.detalleCompra" class="border-b hover:bg-gray-50">
                            <td class="p-3">
                              <div class="flex justify-start">
                                <div class="border rounded-md overflow-hidden">
                                  <img class="max-h-16 max-w-16 object-cover" src="{{ d.producto.url }}" alt="{{ d.producto.nombre }}">
                                </div>
                              </div>
                            </td>
                            <td class="p-3">
                              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">
                                {{ d.cantidad }}
                              </span>
                            </td>
                            <td class="p-3 text-sm">{{ d.producto.codigo }}</td>
                            <td class="p-3">
                              <div class="font-medium">{{ d.producto.nombre }}</div>
                              <div class="text-sm text-gray-600">{{ d.producto.descripcion }}</div>
                            </td>
                            <td class="p-3 text-sm">{{ d.producto.categoria?.nombre || 'N/A' }}</td>
                            <td class="p-3 font-medium">S/. {{ d.producto.precio }}</td>
                            <td class="p-3 font-semibold text-green-600">
                              S/. {{ (d.producto.precio * d.cantidad).toFixed(2) }}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                  </mat-expansion-panel>
                </mat-accordion>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

    </div>
    
    <!-- Mensaje cuando no hay compras -->
    <div *ngIf="compras.length === 0" class="text-center py-12">
      <mat-icon class="text-gray-400 text-6xl mb-4">shopping_cart_off</mat-icon>
      <h6 class="text-gray-600 font-medium">No tienes compras registradas</h6>
      <p class="text-gray-500 text-sm">Cuando realices una compra, aparecerá aquí</p>
      <button mat-raised-button color="primary" routerLink="/client/productos" class="mt-4">
        <mat-icon>shopping_cart</mat-icon>
        IR A COMPRAR
      </button>
    </div>
  </div>
</div>
