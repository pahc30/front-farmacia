<div class="container max-w-4xl mx-auto p-6">
  <div class="mb-6">
    <h2 class="text-3xl font-bold text-gray-800">Procesar Pago</h2>
    <p class="text-gray-600 mt-2">Complete el proceso de pago</p>
  </div>

  <!-- Resumen de compra -->
  <div class="bg-gray-50 rounded-lg p-6 mb-6">
    <h3 class="text-xl font-semibold mb-4">Resumen de Compra</h3>
    <div class="flex justify-between items-center mb-2">
      <span>Total a pagar:</span>
      <span class="text-2xl font-bold text-green-600">S/.{{ total }}</span>
    </div>
    <div class="flex justify-between items-center">
      <span>Productos:</span>
      <span>{{ productos.length || 0 }} art√≠culos</span>
    </div>
  </div>

  <!-- M√©todo de pago seleccionado -->
  <div class="mb-6" *ngIf="metodoPagoSeleccionado">
    <h3 class="text-xl font-semibold mb-4">M√©todo de Pago Seleccionado</h3>
    <div class="border-2 border-green-500 bg-green-50 rounded-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="font-bold text-lg text-green-800">{{ metodoPagoSeleccionado.tipo }}</h4>
          <p class="text-green-600">{{ metodoPagoSeleccionado.descripcion }}</p>
        </div>
        <div class="text-green-600">
          <mat-icon class="text-3xl">check_circle</mat-icon>
        </div>
      </div>
    </div>
    <button mat-button 
            (click)="regresarAlCarrito()" 
            class="!text-gray-600 mt-2">
      <mat-icon>edit</mat-icon>
      Cambiar m√©todo de pago
    </button>
  </div>

  <!-- Mensaje si no hay m√©todo seleccionado -->
  <div class="mb-6" *ngIf="!metodoPagoSeleccionado">
    <div class="border-2 border-red-300 bg-red-50 rounded-lg p-4">
      <p class="text-red-700">
        <mat-icon class="align-middle mr-2">error</mat-icon>
        No se ha seleccionado un m√©todo de pago. 
      </p>
      <button mat-raised-button 
              color="primary" 
              (click)="regresarAlCarrito()" 
              class="mt-3">
        Regresar al Carrito
      </button>
    </div>
  </div>

  <!-- Formulario de pago Visa -->
  <div *ngIf="esVisa()" class="mb-6">
    <h3 class="text-xl font-semibold mb-4">Datos de Tarjeta</h3>
    <div [formGroup]="form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <mat-form-field class="w-full">
        <mat-label>N√∫mero de Tarjeta</mat-label>
        <input matInput formControlName="cardNumber" placeholder="1234 5678 9012 3456">
        <mat-error *ngIf="frmValidationUtils?.hasErrors('cardNumber')">
          {{ frmValidationUtils.getErrorMessages('cardNumber', 'N√∫mero de tarjeta') }}
        </mat-error>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>CVV</mat-label>
        <input matInput formControlName="cardCvv" placeholder="123">
        <mat-error *ngIf="frmValidationUtils?.hasErrors('cardCvv')">
          {{ frmValidationUtils.getErrorMessages('cardCvv', 'CVV') }}
        </mat-error>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Nombres</mat-label>
        <input matInput formControlName="cardNombre">
        <mat-error *ngIf="frmValidationUtils?.hasErrors('cardNombre')">
          {{ frmValidationUtils.getErrorMessages('cardNombre', 'Nombres') }}
        </mat-error>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Apellidos</mat-label>
        <input matInput formControlName="cardApellido">
        <mat-error *ngIf="frmValidationUtils?.hasErrors('cardApellido')">
          {{ frmValidationUtils.getErrorMessages('cardApellido', 'Apellidos') }}
        </mat-error>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Mes de Expiraci√≥n</mat-label>
        <mat-select formControlName="cardExpMonth">
          <mat-option *ngFor="let mes of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="mes">
            {{ mes.toString().padStart(2, '0') }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>A√±o de Expiraci√≥n</mat-label>
        <mat-select formControlName="cardExpYear">
          <mat-option *ngFor="let year of [2024,2025,2026,2027,2028,2029,2030]" [value]="year">
            {{ year }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Simulaci√≥n de QR para Yape/Plin -->
  <div *ngIf="mostrandoPago && esYapeOPlin()" class="mb-6 text-center bg-blue-50 p-6 rounded-lg border">
    <!-- Timer de cuenta regresiva -->
    <div *ngIf="timerActivo" class="mb-4 p-3 bg-orange-100 border border-orange-300 rounded-lg">
      <div class="flex items-center justify-center space-x-2">
        <mat-icon class="text-orange-600">timer</mat-icon>
        <span class="text-orange-800 font-bold text-lg">{{ formatearTiempo() }}</span>
        <span class="text-orange-600 text-sm">restante</span>
      </div>
      <p class="text-orange-700 text-sm mt-1">‚ö†Ô∏è Complete el pago antes de que termine el tiempo</p>
    </div>
    
    <h3 class="text-xl font-semibold mb-4 text-blue-800">üí≥ Escanea el c√≥digo QR</h3>
    <div class="bg-white p-6 rounded border inline-block shadow-lg">
      <img [src]="qrUrl" alt="C√≥digo QR para pago" class="w-64 h-64 border-2 border-gray-300">
    </div>
    <div class="mt-4">
      <p class="text-lg font-medium text-blue-700">Escanea este c√≥digo con tu app {{ metodoPagoSeleccionado?.tipo }}</p>
      <p class="text-gray-600 mt-2">üí∞ Monto: <strong>S/.{{ total }}</strong></p>
      <p class="text-gray-600">üì± Escanea este c√≥digo con tu celular. El sistema detectar√° autom√°ticamente cuando lo hayas escaneado.</p>
      <!-- Estados del QR -->
      <div *ngIf="qrToken" class="mt-3 p-3 bg-gray-100 rounded">
        <p class="text-sm font-mono">QR Token: {{ qrToken }}</p>
      </div>
    </div>
    
    <!-- Indicadores de estado mejorados -->
    <div class="mt-6 space-y-3">
      <!-- Esperando escaneo -->
      <div *ngIf="esperandoEscaneo && !qrEscaneado" class="p-4 bg-yellow-50 rounded border border-yellow-200">
        <div class="flex items-center justify-center space-x-2">
          <div class="animate-pulse w-3 h-3 bg-yellow-400 rounded-full"></div>
          <span class="text-yellow-700 font-medium">Esperando que escanees el QR...</span>
        </div>
        <p class="text-yellow-600 text-sm mt-2">üí° Tip: Tambi√©n puedes usar el bot√≥n "Simular Escaneo" para probar</p>
      </div>
      
      <!-- QR escaneado -->
      <div *ngIf="qrEscaneado" class="p-4 bg-green-50 rounded border border-green-200">
        <div class="flex items-center justify-center space-x-2">
          <mat-icon class="text-green-600">check_circle</mat-icon>
          <span class="text-green-700 font-medium">¬°QR Escaneado Exitosamente!</span>
        </div>
        <p class="text-green-600 text-sm mt-2">üéâ Procesando pago autom√°ticamente...</p>
      </div>
      
      <!-- Pago completado -->
      <div *ngIf="pagoCompletado" class="p-4 bg-blue-50 rounded border border-blue-200">
        <div class="flex items-center justify-center space-x-2">
          <mat-icon class="text-blue-600">payment</mat-icon>
          <span class="text-blue-700 font-medium">Finalizando compra...</span>
        </div>
      </div>
    </div>
    
    <!-- Botones de acci√≥n QR -->
    <div class="mt-6 flex justify-center space-x-4">
      <!-- Bot√≥n para simular escaneo (para testing) -->
      <button *ngIf="esperandoEscaneo && !qrEscaneado" 
              mat-raised-button 
              color="warn" 
              (click)="simularEscaneoQR()">
        üß™ Simular Escaneo
      </button>
      
      <!-- Bot√≥n para confirmar despu√©s del escaneo -->
      <button *ngIf="qrEscaneado && !pagoCompletado" 
              mat-raised-button 
              color="accent" 
              (click)="confirmarPago()">
        ‚úÖ Confirmar Pago
      </button>
    </div>
  </div>

  <!-- Simulaci√≥n de formulario para Visa -->
  <div *ngIf="mostrandoPago && esVisa()" class="mb-6 text-center bg-green-50 p-6 rounded-lg border">
    <!-- Timer de cuenta regresiva -->
    <div *ngIf="timerActivo" class="mb-4 p-3 bg-orange-100 border border-orange-300 rounded-lg">
      <div class="flex items-center justify-center space-x-2">
        <mat-icon class="text-orange-600">timer</mat-icon>
        <span class="text-orange-800 font-bold text-lg">{{ formatearTiempo() }}</span>
        <span class="text-orange-600 text-sm">restante</span>
      </div>
      <p class="text-orange-700 text-sm mt-1">‚ö†Ô∏è Complete el pago antes de que termine el tiempo</p>
    </div>
    
    <h3 class="text-xl font-semibold mb-4 text-green-800">üí≥ Pago con Tarjeta Visa</h3>
    <div class="p-4 bg-white rounded border shadow">
      <p class="text-green-700 font-medium">‚úÖ Datos de tarjeta validados correctamente</p>
      <p class="text-gray-600 mt-2">üí∞ Monto: <strong>S/.{{ total }}</strong></p>
      <p class="text-gray-600">Haz click en "Confirmar Pago" para procesar la transacci√≥n</p>
      <!-- Botones dentro del √°rea de pago Visa -->
      <button *ngIf="!pagoCompletado" 
              mat-raised-button 
              color="accent" 
              (click)="confirmarPago()">
        üí≥ Confirmar Pago Visa
      </button>
      <!-- Debug Info (temporal) -->
  <div class="mb-4 p-4 bg-red-100 border-2 border-red-300 rounded text-sm">
    <p><strong>üîß DEBUG INFO:</strong></p>
    <p>M√©todo seleccionado: <strong>{{ metodoPagoSeleccionado?.tipo || 'NINGUNO SELECCIONADO' }}</strong></p>
    <p>ID del m√©todo: {{ metodoPagoSeleccionado?.id || 'N/A' }}</p>
    <p>Es Yape/Plin: <span class="font-bold {{ esYapeOPlin() ? 'text-green-600' : 'text-red-600' }}">{{ esYapeOPlin() }}</span></p>
    <p>Es Visa: <span class="font-bold {{ esVisa() ? 'text-green-600' : 'text-red-600' }}">{{ esVisa() }}</span></p>
    <p>Mostrando Pago: {{ mostrandoPago }}</p>
    <p>Total productos: {{ productos.length || 0 }}</p>
  </div>

  <!-- Botones de acci√≥n -->
  <div class="flex justify-between items-center">
    <button mat-button (click)="regresarAlCarrito()" class="!text-gray-600">
      <mat-icon>arrow_back</mat-icon>
      Regresar al Carrito
    </button>

    <div class="space-x-4">
      <!-- Bot√≥n SIEMPRE VISIBLE para debug -->
      <button mat-raised-button 
              color="warn" 
              class="!bg-red-500 !text-white"
              (click)="simularPagoYape()">
        üß™ PRUEBA YAPE (SIEMPRE VISIBLE)
      </button>

      <!-- Bot√≥n para Yape/Plin -->
      <button *ngIf="!mostrandoPago && metodoPagoSeleccionado?.tipo && metodoPagoSeleccionado.tipo.toLowerCase().includes('yape')" 
              mat-raised-button 
              color="primary" 
              (click)="simularPagoYape()">
        üéØ Pagar con {{ metodoPagoSeleccionado?.tipo }}
      </button>

      <!-- Bot√≥n para Visa -->
      <button *ngIf="!mostrandoPago && metodoPagoSeleccionado?.tipo && metodoPagoSeleccionado.tipo.toLowerCase().includes('visa')" 
              mat-raised-button 
              color="primary" 
              (click)="procesarPagoVisa()">
        üí≥ Pagar con Tarjeta
      </button>

      <!-- Bot√≥n condicional con debug -->
      <button *ngIf="metodoPagoSeleccionado" 
              mat-raised-button 
              color="accent">
        ‚úÖ M√©todo: {{ metodoPagoSeleccionado?.tipo }}
      </button>

      <!-- Bot√≥n durante procesamiento -->
      <button *ngIf="mostrandoPago" 
              mat-raised-button 
              color="accent" 
              (click)="confirmarPago()">
        Confirmar Pago
      </button>
    </div>
  </div>
  </div>
</div>