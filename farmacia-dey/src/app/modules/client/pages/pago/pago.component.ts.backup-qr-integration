import { Component, OnInit, OnDestroy } from '@angular/core';
import { Router } from '@angular/router';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { MensajesService } from '../../../../core/services/mensajes.service';
import { MetodopagoService } from '../../../admin/services/metodo-pago.service';
import { FormValidationUtils } from '../../../../utils/form-validation-utils';
import { RouteDataService } from '../../../../core/services/route-data.service';
import { CompraService } from '../../services/compra.service';
import { CarritoCounterService } from '../../../../core/services/carrito-counter.service';

@Component({
  selector: 'app-pago',
  templateUrl: './pago.component.html',
  styleUrls: ['./pago.component.css']
})
export class PagoComponent implements OnInit, OnDestroy {

  // Variables principales de los datos del carrito
  datoCompra: any = null;
  productos: any[] = [];
  metodos: any[] = [];
  metodoPagoSeleccionado: any = null;
  total: number = 0;
  
  // Variables de pago
  transaccionCreada: any = null;
  qrUrl: string | null = null;
  mostrandoPago: boolean = false;
  pagoSimulado: boolean = false;
  
  // Timer de pago
  timerActivo: boolean = false;
  tiempoRestante: number = 60;
  intervalTimer: any = null;
  
  // Formulario para Visa
  form!: FormGroup;
  frmValidationUtils!: FormValidationUtils;

  constructor(
    private router: Router,
    private formBuilder: FormBuilder,
    private mensaje: MensajesService,
    private metodoPagoService: MetodopagoService,
    private routeDataService: RouteDataService,
    private compraService: CompraService,
    private carritoCounterService: CarritoCounterService
  ) {
    this.initForm();
  }

  ngOnInit(): void {
    // Obtener datos del carrito desde RouteDataService
    this.datoCompra = this.routeDataService.getData();
    
    if (!this.datoCompra) {
      this.mensaje.showMessageError('No hay datos de compra disponibles');
      this.router.navigate(['/client/carrito']);
      return;
    }

    this.productos = this.datoCompra.productos || [];
    this.metodos = this.datoCompra.metodos || [];
    this.total = this.datoCompra.total || 0;

    // Pre-seleccionar el método de pago del carrito
    if (this.datoCompra.metodoPagoId) {
      const metodoSeleccionado = this.metodos.find(m => m.id === this.datoCompra.metodoPagoId);
      if (metodoSeleccionado) {
        this.seleccionarMetodo(metodoSeleccionado);
      }
    }

    console.log('Datos de compra recibidos:', this.datoCompra);
  }

  initForm(): void {
    this.form = this.formBuilder.group({
      metodoPago: ['', Validators.required],
      // Campos para Visa
      cardNumber: ['', [Validators.required, Validators.pattern(/^\d{13,19}$/)]],
      cardNombre: ['', Validators.required],
      cardApellido: ['', Validators.required],
      cardCvv: ['', [Validators.required, Validators.pattern(/^\d{3,4}$/)]],
      cardCuotas: ['1', Validators.required],
      cardExpMonth: ['', [Validators.required, Validators.min(1), Validators.max(12)]],
      cardExpYear: ['', [Validators.required, Validators.min(2024)]]
    });

    this.frmValidationUtils = new FormValidationUtils(this.form);
  }

  seleccionarMetodo(metodo: any): void {
    this.metodoPagoSeleccionado = metodo;
    this.form.patchValue({ metodoPago: metodo.id });
    console.log('Método seleccionado:', metodo);
  }

  // Método para simular pago con Yape/Plin
  simularPagoYape(): void {
    if (!this.metodoPagoSeleccionado) {
      this.mensaje.showMessageError('Selecciona un método de pago');
      return;
    }

    const metodoTexto = this.metodoPagoSeleccionado.tipo.toLowerCase();
    if (!metodoTexto.includes('yape') && !metodoTexto.includes('plin')) {
      this.mensaje.showMessageError('Método de pago no válido para Yape/Plin');
      return;
    }

    // Solo mostrar una notificación breve al generar QR
    this.mensaje.showMessageSuccess(`Código QR generado para ${this.metodoPagoSeleccionado.tipo}`);
    
    // Generar código QR simulado
    const payload = `Pago: S/.${this.total} - Compra farmacia DeY`;
    this.qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(payload)}`;
    this.mostrandoPago = true;
    this.iniciarTimer();
  }

  // Método para simular pago con Visa
  procesarPagoVisa(): void {
    if (!this.metodoPagoSeleccionado) {
      this.mensaje.showMessageError('Selecciona un método de pago');
      return;
    }

    const metodoTexto = this.metodoPagoSeleccionado.tipo.toLowerCase();
    if (!metodoTexto.includes('visa')) {
      this.mensaje.showMessageError('Método de pago no válido para Visa');
      return;
    }

    // Validar campos de tarjeta
    if (!this.form.get('cardNumber')?.value || !this.form.get('cardNombre')?.value ||
        !this.form.get('cardApellido')?.value || !this.form.get('cardCvv')?.value) {
      this.mensaje.showMessageError('Complete todos los datos de la tarjeta');
      return;
    }

    // Solo una notificación de validación exitosa
    this.mensaje.showMessageSuccess('Datos de tarjeta validados correctamente');
    this.mostrandoPago = true;
    this.iniciarTimer();
  }

  // Confirmar pago y completar la compra
  confirmarPago(): void {
    if (this.pagoSimulado) {
      return; // Evitar doble ejecución
    }

    this.pagoSimulado = true;
    
    // Limpiar notificaciones anteriores y mostrar proceso de confirmación
    this.mensaje.showLoading();

    // Simular tiempo de procesamiento
    setTimeout(() => {
      // 1. Crear la compra primero
      const datoFinal = {
        usuarioId: this.datoCompra.usuarioId,
        metodoPagoId: this.metodoPagoSeleccionado?.id || this.datoCompra.metodoPagoId,
        detalleCompra: this.datoCompra.detalleCompra,
      };

      this.compraService.save(datoFinal).subscribe({
        next: (compraRes) => {
          // 2. Crear PaymentIntent (transacción) con el ID de compra
          const paymentRequest = {
            compraId: compraRes.dato.id,
            metodoPagoId: this.metodoPagoSeleccionado?.id,
            monto: this.total,
            moneda: 'PEN',
            descripcion: `Pago farmacia - ${this.productos.length} productos`,
            // Datos de la tarjeta (para Visa)
            cardNumber: this.form.get('cardNumber')?.value,
            cardNombre: this.form.get('cardNombre')?.value,
            cardApellido: this.form.get('cardApellido')?.value,
            cardCvv: this.form.get('cardCvv')?.value,
            cardExpMonth: this.form.get('cardExpMonth')?.value,
            cardExpYear: this.form.get('cardExpYear')?.value,
            cardCuotas: this.form.get('cardCuotas')?.value || 1
          };

          this.metodoPagoService.crearPaymentIntent(paymentRequest).subscribe({
            next: (paymentRes) => {
              if (paymentRes.success) {
                // 3. Confirmar el pago
                this.metodoPagoService.confirmarPago(paymentRes.transaccionId).subscribe({
                  next: (confirmRes) => {
                    this.mensaje.closeLoading();
                    if (confirmRes.success) {
                      this.detenerTimer();
                      this.mensaje.showMessageSuccess('¡Pago confirmado exitosamente!');
                      this.carritoCounterService.updateCount(0);
                      // Navegar a la página de compras después de un delay
                      setTimeout(() => {
                        this.router.navigate(['/client/compras']);
                      }, 2000);
                    } else {
                      this.mensaje.showMessageError('Error confirmando el pago');
                      this.pagoSimulado = false;
                    }
                  },
                  error: (err) => {
                    this.detenerTimer();
                    this.mensaje.closeLoading();
                    this.mensaje.showMessageError('Error en la confirmación del pago');
                    this.pagoSimulado = false;
                  }
                });
              } else {
                this.mensaje.closeLoading();
                this.mensaje.showMessageError('Error procesando el pago: ' + paymentRes.message);
                this.pagoSimulado = false;
              }
            },
            error: (err) => {
              this.mensaje.closeLoading();
              this.mensaje.showMessageErrorObservable(err);
              this.pagoSimulado = false;
            }
          });
        },
        error: (err) => {
          this.mensaje.closeLoading();
          this.mensaje.showMessageErrorObservable(err);
          this.pagoSimulado = false;
        }
      });
    }, 1500); // Reducido a 1.5 segundos de procesamiento
  }

  // Regresar al carrito
  regresarCarrito(): void {
    this.router.navigate(['/client/carrito']);
  }

  // Cancelar el proceso de pago
  cancelarPago(): void {
    this.detenerTimer();
    this.regresarCarrito();
  }

  // Métodos auxiliares para verificar tipo de método de pago
  esYapeOPlin(): boolean {
    if (!this.metodoPagoSeleccionado) return false;
    const tipo = this.metodoPagoSeleccionado.tipo.toLowerCase();
    return tipo.includes('yape') || tipo.includes('plin');
  }

  esVisa(): boolean {
    if (!this.metodoPagoSeleccionado) return false;
    const tipo = this.metodoPagoSeleccionado.tipo.toLowerCase();
    return tipo.includes('visa');
  }

  // Funciones del timer de pago
  iniciarTimer(): void {
    this.timerActivo = true;
    this.tiempoRestante = 60;
    
    this.intervalTimer = setInterval(() => {
      this.tiempoRestante--;
      
      if (this.tiempoRestante <= 0) {
        this.timeoutPago();
      }
    }, 1000);
  }

  detenerTimer(): void {
    if (this.intervalTimer) {
      clearInterval(this.intervalTimer);
      this.intervalTimer = null;
    }
    this.timerActivo = false;
  }

  timeoutPago(): void {
    this.detenerTimer();
    this.mostrandoPago = false;
    this.pagoSimulado = false;
    this.mensaje.showMessageWarning('⏰ Tiempo agotado. La compra ha sido cancelada por inactividad');
    
    // Aquí podrías llamar al backend para marcar la transacción como fallida si ya se creó
    // this.metodoPagoService.cancelarPorTimeout(transaccionId)
  }

  formatearTiempo(): string {
    const minutos = Math.floor(this.tiempoRestante / 60);
    const segundos = this.tiempoRestante % 60;
    return `${minutos}:${segundos.toString().padStart(2, '0')}`;
  }

  ngOnDestroy(): void {
    this.detenerTimer();
  }
}